export OMPI_FC= gfortran

export USE_MPI = YES
export USE_RAD_ECMWF = YES

BOLAM = YES
MOLOCH = YES
GLOBO = YES
GRAPHICS_PLGRIBFA = YES

export FC = gfortran
export FC_MPI = mpif90

export FCFLAGS = -Ofast -g -fbacktrace -march=native -funroll-loops -ffpe-summary=none -w
###export FCFLAGS = -g -fallow-argument-mismatch -fbacktrace -ffpe-trap=invalid,zero,overflow -fbounds-check -ffpe-summary=none -pg # debuger options
# -pg - profiling (report of routines execution time)
# -fallow-argument-mismatch - option for gfortran version 9.2 and later

# -fallow-argument-mismatch to block the false error in call mpi_recv  
# Globo not work with this options
export FCFLAGS_MPI = -Dmpi -g -fallow-argument-mismatch -O2 -march=native -funroll-loops -w -ffpe-summary=none -finit-integer=0 -finit-local-zero -finit-real=zero
# Options for error searching
###export FCFLAGS_MPI = -Dmpi -g -fallow-argument-mismatch -O2 -march=native -funroll-loops -w -ffpe-summary=none -ffpe-trap=invalid,zero,overflow
# Options analogue to ifort, working!!!
###export FCFLAGS_MPI = -Dmpi -g -fallow-argument-mismatch -O2 -march=native -funroll-loops -w -ffpe-summary=none -finit-integer=0 -finit-local-zero -finit-real=zero

FCFLAGS += -Doper
FCFLAGS_MPI += -Doper

export DIR_START = $(shell pwd)
export DIR_LIB = $(HOME)

export DIR_ECCODES = $(DIR_LIB)/eccodes/eccodes_$(FC)

ifeq ($(USE_RAD_ECMWF),YES)
  export DIR_RAD = $(DIR_LIB)/rad_ecmwf/executable_$(FC)
endif

export DIR_SOURCES_GLOBO = $(DIR_START)/sources/globo
export DIR_SOURCES_BOLAM = $(DIR_START)/sources/bolam
export DIR_SOURCES_MOLOCH = $(DIR_START)/sources/moloch
export DIR_SOURCES_COMMON = $(DIR_START)/sources/common

SUBDIRS =

ifeq ($(BOLAM),YES)
  SUBDIRS += bolam/executable_premodel bolam/executable_model\
 bolam/executable_postmodel bolam/executable_convert_shf_to_grib2\
 bolam/executable_meteograms
endif

ifeq ($(MOLOCH),YES)
  SUBDIRS += moloch/executable_premodel moloch/executable_model\
 moloch/executable_postmodel moloch/executable_convert_shf_to_grib2\
 moloch/executable_meteograms
endif

ifeq ($(GLOBO),YES)
  SUBDIRS += globo/executable_premodel globo/executable_model\
 globo/executable_postmodel globo/executable_convert_shf_to_grib2\
 globo/executable_meteograms
endif

ifeq ($(GRAPHICS_PLGRIBFA),YES)
  export DIR_PLPLOT = /usr/lib/x86_64-linux-gnu/fortran/modules/plplot
  export DIR_SOURCES_PLGRIBFA = $(DIR_START)/sources/plgribfa
  export DIR_ECCODES_GFORTRAN = $(DIR_LIB)/eccodes/eccodes_gfortran
  SUBDIRS += executable_plgribfa
endif

all:
	for subdir in $(SUBDIRS); do cd $$subdir && $(MAKE); cd -; done

clean:
	for subdir in $(SUBDIRS); do cd $$subdir && $(MAKE) clean; cd -; done
